name: ü§ñ AI Code Review (SIN github-script)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2. LEER src/example.js
      - name: Read code file
        id: code
        run: |
          if [ -f "src/example.js" ]; then
            CODE=$(cat src/example.js)
          else
            CODE="Archivo src/example.js no encontrado"
          fi
          echo "content=$CODE" >> $GITHUB_OUTPUT

      # 3. TODO EN UN SOLO PASO bash (SIN github-script)
      - name: üîÆ Analyze + Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # Datos del PR desde GitHub API
          PR_TITLE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER" \
            | jq -r '.title // "Sin t√≠tulo"')
          
          PR_BODY=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER" \
            | jq -r '.body // "Sin descripci√≥n"')
          
          # C√≥digo a analizar
          CODE="${{ steps.code.outputs.content }}"
          
          # Prompt para el modelo
          PROMPT="Eres revisor de c√≥digo para estudiantes.

**C√ìDIGO ANALIZADO (src/example.js):**
\`\`\`javascript
$CODE
\`\`\`

**PR #$PR_NUMBER:**
T√≠tulo: '$PR_TITLE'
Descripci√≥n: '$PR_BODY'

**AN√ÅLISIS (Markdown):**
## üêõ BUGS DETECTADOS
## üîß C√ìDIGO CORREGIDO  
## ‚úÖ TESTS UNITARIOS
## üìù FEEDBACK PR

Espa√±ol claro, educativo."

          # 4. LLAMAR GitHub Models API
          AI_RESPONSE=$(curl -s -X POST \
            https://models.inference.ai.azure.com/chat/completions \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [{\"role\": \"user\", \"content\": \"$PROMPT\"}],
              \"temperature\": 0.3
            }" | jq -r '.choices[0].message.content // "‚ùå Error del modelo"')

          # 5. COMENTAR en PR
          COMMENT="## ü§ñ **AI Code Review** (GitHub Models)

**Analiz√≥:** \`src/example.js\` (\`${{ github.sha.slice(0,7) }}\`)

\`\`\`
$AI_RESPONSE
\`\`\`

---
*Autom√°tico*"

          curl -s -X POST \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/comments" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"body\": \"$COMMENT\"}" \
            | jq .

          echo "‚úÖ AI review posted!"

      # 6. Labels (SIN github-script)
      - name: Add labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            "https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/issues/${{ github.event.pull_request.number }}/labels" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -d '["ai-reviewed"]' \
            | jq .
