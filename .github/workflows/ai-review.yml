name: Analisis IA Codigo

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  revision-ia:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Leer codigo ejemplo
        id: codigo
        run: |
          CODIGO=$(cat src/example.js 2>/dev/null || echo "Archivo no encontrado")
          echo "contenido<<EOF" >> $GITHUB_OUTPUT
          echo "$CODIGO" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Revision IA completa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Leer codigo
          CODIGO="${{ steps.codigo.outputs.contenido }}"
          
          # Detectar tipo evento
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            TIPO="PR #$PR_NUM"
            URL_COMENT="https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUM/comments"
            
            TITULO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM" | jq -r '.title')
            BODY=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM" | jq -r '.body')
          else
            TIPO="Push main (${{ github.sha.slice(0,7) }})"
            URL_COMENT="https://api.github.com/repos/${{ github.repository }}/issues"
            TITULO="Commit main"
            BODY="Analisis automatico"
          fi
          
          # Prompt usando heredoc (sin problemas YAML)
          read -r -d '' PROMPT << EOF || true
Eres revisor de codigo para estudian
